# gohu

[![build](https://img.shields.io/badge/build-1.01-brightgreen)](https://github.com/StellarisW/StellarisW)[![go-version](https://img.shields.io/badge/go-~%3D1.8-30dff3?logo=go)](https://github.com/StellarisW/StellarisW)[![OpenTracing Badge](https://img.shields.io/badge/OpenTracing-enabled-blue.svg)](http://opentracing.io)[![PyPI](https://img.shields.io/badge/License-BSD_2--Clause-green.svg)](https://github.com/emirpasic/gods/blob/master/LICENSE)

> Go å®ç°çš„çŸ¥ä¹ç½‘ç«™åç«¯

## ğŸ’¡  ç®€ä»‹

åŸºäº [go-zero ](https://github.com/zeromicro/go-zero)å¾®æœåŠ¡æ¡†æ¶å®ç°çš„ä¸€ä¸ªç®€å•çŸ¥ä¹ç½‘ç«™åç«¯

## ğŸš€ åŠŸèƒ½

[æ¼”ç¤ºè§†é¢‘](https://typora.stellaris.wang/gohu-show-video.mp4)

### è®¤è¯ç³»ç»Ÿ

- é¢å‘ `oauth2 token`  (åŒ…å« `access token` å’Œ `refresh token`)
- å¯¹ä»¤ç‰Œè¿›è¡Œè§£æè·å–è®¤è¯ä¿¡æ¯ä¸ç”¨æˆ·ä¿¡æ¯

### ç”¨æˆ·ç³»ç»Ÿ

- ç”¨æˆ·çš„ç™»å½•ä¸æ³¨å†Œ
- ç”¨æˆ·æ”¹å
- å–œæ¬¢æˆ–èµåŒå›ç­”ã€è¯„è®º
- å…³æ³¨ç”¨æˆ·
- æ”¶è—å›ç­”
- è·å–è‡ªå·±çš„å›ç­”ä¸è¯„è®º

### é—®ç­”ç³»ç»Ÿ

- å¯¹é—®é¢˜çš„å¢åˆ æŸ¥æ”¹
- å¯¹å›ç­”çš„å¢åˆ æŸ¥æ”¹

### è¯„è®ºç³»ç»Ÿ

- å¯¹å›ç­”è¿›è¡Œè¯„è®º
- å¯ä»¥å¯¹è¯„è®ºè¿›è¡Œå›å¤

### é€šçŸ¥ç³»ç»Ÿ

- å…³æ³¨çš„ç”¨æˆ·å‘å¸ƒé—®é¢˜ï¼Œå›ç­”é—®é¢˜

- å‘å¸ƒçš„é—®é¢˜è¢«å›ç­”ä¼šå¾—åˆ°é€šçŸ¥
- é—®é¢˜çš„å›ç­”è¢«è¯„è®ºä¼šå¾—åˆ°é€šçŸ¥
- è¯„è®ºè¢«å›å¤ä¼šå¾—åˆ°é€šçŸ¥
- å›ç­”æˆ–è¯„è®ºè¢«ç‚¹èµä¼šå¾—åˆ°é€šçŸ¥

## ğŸŒŸ äº®ç‚¹

### æŠ€æœ¯æ ˆ

![image-20220904045303624](./manifest/image/go-zero.png)

- [go-zero](https://go-zero.dev/)

> ä¸€ä¸ªé›†æˆäº†å„ç§å·¥ç¨‹å®è·µçš„åŒ…å« å¾®æœåŠ¡æ¡†æ¶
>
> å®ƒå…·æœ‰é«˜æ€§èƒ½ï¼ˆé«˜å¹¶å‘æ”¯æ’‘ï¼Œè‡ªåŠ¨ç¼“å­˜æ§åˆ¶ï¼Œè‡ªé€‚åº”ç†”æ–­ï¼Œè´Ÿè½½å‡è¡¡ï¼‰ã€æ˜“æ‹“å±•ï¼ˆæ”¯æŒä¸­é—´ä»¶ï¼Œæ–¹ä¾¿æ‰©å±•ï¼Œé¢å‘æ•…éšœç¼–ç¨‹ï¼Œå¼¹æ€§è®¾è®¡ï¼‰ã€ä½é—¨æ§›ï¼ˆå¤§é‡å¾®æœåŠ¡æ²»ç†å’Œå¹¶å‘å·¥å…·åŒ…ã€goctlè‡ªåŠ¨ç”Ÿæˆä»£ç å¾ˆé¦™ï¼‰ï¼Œ

â€‹     åŒæ—¶go-zeroä¹Ÿæ˜¯ç°åœ¨æœ€æµè¡Œçš„goå¾®æœåŠ¡æ¡†æ¶ï¼Œæ‰€ä»¥æœ¬é¡¹ç›®é‡‡ç”¨go-zeroä¸ºä¸»æ¡†æ¶æ­å»ºçŸ¥ä¹åç«¯

![](./manifest/image/mysql.svg)

- [mysql](https://www.mysql.com/)

> ä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œç”±ç‘å…¸MySQL AB å…¬å¸å¼€å‘ï¼Œå±äº Oracle æ——ä¸‹äº§å“ã€‚MySQL æ˜¯æœ€æµè¡Œçš„å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¹‹ä¸€ï¼Œåœ¨ WEB åº”ç”¨æ–¹é¢ï¼ŒMySQLæ˜¯æœ€å¥½çš„ RDBMS (Relational Database Management Systemï¼Œå…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ) åº”ç”¨è½¯ä»¶ä¹‹ä¸€

â€‹    é‡äº‹ä¸å†³è¿˜å¾—æ˜¯mysqlï¼Œåç»­æœ‰ç©ºï¼ˆæœ‰é’±ï¼‰ä¼š	æ”¹è¿›æˆ [TiDB](https://pingcap.com/zh/case/)ï¼Œå°†å…¶åˆ†å¸ƒå¼åŒ–

![](./manifest/image/redis.svg)

- [redis](https://redis.io/)

> ä¸€ä¸ªå¼€æºçš„ã€ä½¿ç”¨Cè¯­è¨€ç¼–å†™çš„ã€æ”¯æŒç½‘ç»œäº¤äº’çš„ã€å¯åŸºäºå†…å­˜ä¹Ÿå¯æŒä¹…åŒ–çš„Key-Valueæ•°æ®åº“

â€‹    ç¼“å­˜å­˜å‚¨è¿˜æ˜¯é€‰å‹æœ€æ™®éçš„redis

<img src="./manifest/image/nsq.png" width="15%">

- [nsq](https://nsq.io/)

>  Go è¯­è¨€ç¼–å†™çš„å¼€æºåˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œå…·å¤‡éå¸¸å¥½çš„æ€§èƒ½ã€æ˜“ç”¨æ€§å’Œå¯ç”¨æ€§

â€‹    åˆšå¼€å§‹æƒ³ç”¨RabbitMQï¼Œä½†æ˜¯å¾ˆéš¾åšåˆ°é›†ç¾¤å’Œæ°´å¹³æ‰©å±•ï¼Œå†çœ‹äº†çœ‹å…¶ä»–çš„é˜Ÿåˆ—ç»„ä»¶ï¼ˆDarnerï¼ŒRedisï¼ŒKestrelå’ŒKafkaï¼‰ï¼Œæ¯ç§é˜Ÿåˆ—ç»„ä»¶éƒ½æœ‰ä¸åŒçš„æ¶ˆæ¯ä¼ è¾“ä¿     	è¯ï¼Œä½†ä¼¼ä¹å¹¶æ²¡æœ‰ä¸€ç§èƒ½åœ¨å¯æ‰©å±•æ€§å’Œæ“ä½œç®€æ˜“æ€§ä¸Šéƒ½æ¯”è¾ƒä¼˜ç§€çš„äº§å“ã€‚

â€‹    ç„¶åå°±çœ‹åˆ°äº†nsqï¼Œæ”¯æŒæ¨ªå‘æ‹“å±•ï¼Œæ€§èƒ½ä¹Ÿå¾ˆå¥½ï¼ŒåŒæ—¶ä¹Ÿæ˜¯goè¯­è¨€åŸç”Ÿå¼€å‘çš„ï¼Œå› æ­¤é€‰å‹nsqåšå‘å¸ƒè®¢é˜…æ“ä½œï¼ˆé€šçŸ¥ç³»ç»Ÿé‡Œä¼šç”¨åˆ°ï¼‰

<img src="./manifest/image/asynq.png" width="15%">

- [asynq](https://github.com/hibiken/asynq)

> goè¯­è¨€å®ç°çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—å’Œå¼‚æ­¥å¤„ç†åº“ï¼ŒåŸºäºredisï¼Œç±»ä¼¼sidekiqå’Œcelery

â€‹	asynqæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ¬é¡¹ç›®ç”¨å®ƒè¿›è¡Œå¼‚æ­¥å®šæ—¶ä»»åŠ¡å¤„ç†ï¼ˆç¼“å­˜ä¸æ•°æ®åº“ä¹‹é—´çš„åŒæ­¥æ“ä½œï¼‰

<img src="./manifest/image/consul.svg" width="25%">

- [consul](https://www.consul.io/)

> ä¸€å¥—å¼€æºçš„åˆ†å¸ƒå¼æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†ç³»ç»Ÿï¼Œç”±HasiCorpå…¬å¸ç”¨goè¯­è¨€å¼€å‘çš„ã€‚æä¾›äº†å¾®æœåŠ¡ç³»ç»Ÿä¸­æœåŠ¡åŠ©ç†ã€é…ç½®ä¸­å¿ƒã€æ§åˆ¶æ€»çº¿ç­‰åŠŸèƒ½

â€‹	åœ¨consulå’Œetcdä¹‹é—´æ¯”è¾ƒï¼Œconsulçš„æœåŠ¡å‘ç°å¾ˆæ–¹ä¾¿ï¼Œä¹Ÿæœ‰å¥åº·æ£€æŸ¥ï¼Œå¤šæ•°æ®ä¸­å¿ƒç­‰åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿæ˜¯goäº‘åŸç”Ÿé¡¹ç›®ï¼Œå› æ­¤é€‰å‹consul

<img src="./manifest/image/jaeger.svg" width="15%">

- [jaeger](https://www.jaegertracing.io/)

> ç”±Uberå¼€æºçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ

â€‹	go-zeroæ¡†æ¶é›†æˆäº†å¯¹jaegerçš„æ”¯æŒï¼Œå› æ­¤ä½¿ç”¨jaegeråšè¿½è¸ªç³»ç»Ÿ

<img src="./manifest/image/apollo.svg" width="10%">

- [apollo](https://www.apolloconfig.com/)

> ä¸€æ¬¾å¯é çš„åˆ†å¸ƒå¼é…ç½®ç®¡ç†ä¸­å¿ƒï¼Œè¯ç”Ÿäºæºç¨‹æ¡†æ¶ç ”å‘éƒ¨ï¼Œèƒ½å¤Ÿé›†ä¸­åŒ–ç®¡ç†åº”ç”¨ä¸åŒç¯å¢ƒã€ä¸åŒé›†ç¾¤çš„é…ç½®ï¼Œé…ç½®ä¿®æ”¹åèƒ½å¤Ÿå®æ—¶æ¨é€åˆ°åº”ç”¨ç«¯ï¼Œå¹¶ä¸”å…·å¤‡è§„èŒƒçš„æƒé™ã€æµç¨‹æ²»ç†ç­‰ç‰¹æ€§ï¼Œé€‚ç”¨äºå¾®æœåŠ¡é…ç½®ç®¡ç†åœºæ™¯

â€‹	ä½¿ç”¨apolloåšé…ç½®ç®¡ç†ç³»ç»Ÿï¼Œå¯ä»¥æœ‰æ•ˆçš„åœ¨è®¤è¯ç³»ç»Ÿï¼Œç”¨æˆ·ç³»ç»Ÿï¼Œé—®ç­”ç³»ç»Ÿç­‰ç­‰ä¸åŒçš„ç¯å¢ƒä¸‹è¿›è¡Œé…ç½®çš„ç®¡ç†

<img src="./manifest/image/traefik-logo.png" width="20%">

- [traefik](https://www.jaegertracing.io/)

> ä¸€ä¸ªä¸ºäº†è®©éƒ¨ç½²å¾®æœåŠ¡æ›´åŠ ä¾¿æ·è€Œè¯ç”Ÿçš„ç°ä»£HTTPåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡å·¥å…·

â€‹	æœ¬é¡¹ç›®å†™çš„å¾®æœåŠ¡å¾ˆå¤šï¼Œç”¨nginxéš¾ç®¡ç†ï¼Œä¹Ÿæ¯”è¾ƒæ‡’å¾—å†™é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥ç”¨traefikï¼Œè™½ç„¶æ€§èƒ½æ²¡nginxå¥½ï¼Œä½†æ˜¯å¯¹å¾®æœåŠ¡çš„åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„æ”¯æŒå¾ˆä¾¿æ·ï¼Œ

â€‹	åŒæ—¶ä½¿ç”¨traefikä¸­çš„httpä¸­é—´ä»¶ï¼Œoauth proxyä¹Ÿå¾ˆæ–¹ä¾¿

<img src="./manifest/image/docker.svg" width="15%">

- [docker](https://www.docker.com/)

> Google å…¬å¸æ¨å‡ºçš„ Go è¯­è¨€ è¿›è¡Œå¼€å‘å®ç°ï¼ŒåŸºäº Linux å†…æ ¸çš„ cgroupï¼Œnamespaceï¼Œä»¥åŠ AUFS ç±»çš„ Union FS ç­‰æŠ€æœ¯çš„ä¸€ä¸ªå®¹å™¨æœåŠ¡

â€‹	å®¹å™¨ç”¨docker-composeéƒ¨ç½²

<img src="./manifest/image/drone.svg" width="20%">

- [drone](https://www.drone.io/)

> ä¸€æ¬¾åŸºäºgoç¼–å†™çš„å®¹å™¨æŠ€æœ¯æŒç»­é›†æˆå·¥å…·ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨YAMLé…ç½®æ–‡ä»¶å³å¯å®Œæˆè‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²ä»»åŠ¡

â€‹	ç»“åˆgogsä»“åº“ï¼Œæ¥å¯¹é¡¹ç›®è¿›è¡ŒCI/CDæŒç»­é›†æˆï¼Œéƒ¨ç½²æ›´æ–¹ä¾¿äº†

### åç«¯

#### è®¤è¯ç³»ç»Ÿ

- é¢å‘ä»¤ç‰Œ

> å¯¹å‘OAuth2æœåŠ¡å™¨å‘é€è¯·æ±‚é¢å‘ä»¤ç‰Œçš„å®¢æˆ·ç«¯è¿›è¡Œé‰´æƒ, é‰´æƒæˆåŠŸå é¢å‘token
>
> æé«˜äº†ä»¤ç‰Œçš„å®‰å…¨æ€§, åŒæ—¶ä¹Ÿå¯ä»¥æ ¹æ®å®¢æˆ·ç«¯ä¿¡æ¯è‡ªå®šä¹‰ Oauth2 token

<!--app/service/oauth/model/token_granter.go-->

```go
clientId, clientSecret, userId, ok := parseBasicAuth(auth)
if !ok || clientSecret != tokenGranter.ClientDetails[clientId].ClientSecret {
   return nil, ErrInvalidAuthorizationRequest
}
```

è§£æè®¤è¯å¤´ï¼Œåˆ¤æ–­ `clientId` å’Œ `clientSecret` æ˜¯å¦åœ¨å­˜å‚¨åº“ä¸­

é‰´æƒæˆåŠŸåå‘ç”¨æˆ·é¢å‘ token

- ä»¤ç‰Œå­˜å‚¨

> tokenå­˜å‚¨åœ¨redisä¸­, è‡ªåŠ¨å®ç°ä»¤ç‰Œçš„è¿‡æœŸåŠŸèƒ½
>
> åŠ å¿«ç”¨æˆ·çš„é‰´æƒæ“ä½œ

![](./manifest/image/jwt-store.png)

<!--app/service/oauth/rpc/token/store/internal/logic/storetokenlogic.go-->

```go
l.svcCtx.Rdb.Set(l.ctx,
   model.JwtToken+"_"+strconv.FormatInt(in.UserId, 10),
   accessTokenString,
   time.Unix(in.AccessToken.RefreshToken.ExpiresAt, 0).Sub(time.Now()))
```

- ä»¤ç‰Œåˆ·æ–°

> access tokençš„è¿‡æœŸæ—¶é—´ä¸º1å¤©ï¼Œrefresh tokençš„è¿‡æœŸæ—¶é—´ä¸º7å¤©ï¼Œå½“access tokenè¿‡æœŸåï¼ŒæœåŠ¡å™¨ä¼šè‡ªåŠ¨ä½¿ç”¨ä¸€æ¬¡æ€§çš„refresh token å¯¹access tokenè¿›è¡Œåˆ·æ–°æ“ä½œï¼Œè·å–æ–°çš„access tokenã€‚
>
> è¿™æ ·ä¼šæœ‰æ•ˆé™ä½å›  access token æ³„éœ²è€Œå¸¦æ¥çš„é£é™©ã€‚

- ä»¤ç‰Œä¼ é€’

> ä½¿ç”¨Cookieè¿›è¡Œåœ¨ç”¨æˆ·ä¸æœåŠ¡å™¨ä¹‹é—´çš„Oauth2 tokenä¼ é€’ï¼ŒåŒæ—¶å¯¹cookieè¿›è¡ŒSHA256åŠ ç›ï¼Œä¿è¯äº†cookieä¸tokençš„å®‰å…¨æ€§
>
> åœ¨è®¤è¯ä¸­é—´ä»¶ä¸­(app/common/middware/authMiddleware.go)å¯¹cookieè¿›è¡Œå“ˆå¸Œæ ¡éªŒï¼Œé˜²æ­¢ç”¨æˆ·ç¯¡æ”¹ï¼Œæ ¡éªŒé€šè¿‡åè§£æcookieè‡ªåŠ¨è·å–tokençš„å…ƒä¿¡æ¯

<!--app/common/middleware/authMiddleware.go-->

```go
res, err := req.NewRequest().SetFormData(map[string]string{"oauth2_token": accessToken, "token_type": model.AccessToken}).
   Post("https://" + m.Domain + "/api/oauth/token/check")
if err != nil {
   logx.Errorf("%v", err)
   return
}
if res.StatusCode != http.StatusOK {
   logx.Errorf("%v", res)
   return
}
j := gjson.Parse(res.String())
ok = j.Get("ok").Bool()
if !ok {
   //ä¸okåˆ™è®¤è¯å¤±è´¥ï¼ŒåŒ…æ‹¬åˆ·æ–°ä»¤ç‰Œ
   //è®¤è¯çš„æ—¶å€™è‹¥è®¤è¯ä»¤ç‰Œè¿‡æœŸï¼Œåˆ™åˆ·æ–°ä»¤ç‰Œ
   msg := j.Get("msg").String()
   // è®¤è¯ä»¤ç‰Œè¿‡æœŸ,ç”¨åˆ·æ–°ä»¤ç‰Œåˆ·æ–°
   if msg == "accessToken is expired" {
      ok = cookieWriter.Get("refresh-token", &refreshToken)
      if accessToken == "" || !ok {
         response.ResultWithData(w, http.StatusForbidden, "illegal access", map[string]interface{}{"reload": true})
         return
      }
      res, err = req.NewRequest().SetPathParam("refresh-token", refreshToken).
         Post("https://" + m.Domain + "/api/oauth/token/refresh")
      if err != nil {
         logx.Errorf("%v", err)
         return
      }
      if res.StatusCode != http.StatusOK {
         return
      }
      j = gjson.Parse(res.String())
      accessToken = j.Get("data.access_token.token_value").String()
      refreshToken = j.Get("data.access_token.refresh_token.token_value").String()
      cookieWriter.Set("x-token", accessToken)
      cookieWriter.Set("refresh-token", refreshToken)
   }
}
```

#### ç”¨æˆ·ç³»ç»Ÿ

- ç™»å½•ä¸æ³¨å†Œ

> ç”¨æˆ·æ³¨å†Œæˆ–é¦–æ¬¡ç™»å½•å¾—åˆ°ä»¤ç‰Œï¼Œå¯ä»¥åœ¨ä»¤ç‰Œæœ‰æ•ˆæœŸå†…å®ç°è‡ªåŠ¨ç™»å½•æ“ä½œï¼Œ
>
> åœ¨ç”¨æˆ·æ³¨å†Œæˆ–ç™»å½•åè®¾ç½®æ³¨å†Œ/ç™»å½•ç¼“å­˜ï¼ŒåŒæ—¶ç‰¹åˆ«é’ˆå¯¹ç™»å½•è®¾ç½®äº†ç©ºç¼“å­˜ï¼Œé˜²æ­¢å¤§é‡æ— æ•ˆè¯·æ±‚é€ æˆç¼“å­˜ç©¿é€

<!--app/service/user/rpc/crud/internal/logic/registerlogic.go-->

```go
ok, err := l.svcCtx.Rdb.SIsMember(l.ctx,
   "user_register_set",
   in.Username).Result()
```

<!--app/service/user/rpc/crud/internal/logic/loginlogic.go-->

```go
	// åœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾ç”¨æˆ·
	userSubjectModel := l.svcCtx.UserModel.UserSubject
	userSubject, err := userSubjectModel.WithContext(l.ctx).Where(userSubjectModel.Username.Eq(in.Username)).First()
	switch err {
	case nil:
	case gorm.ErrRecordNotFound:
		// è®¾ç½®ç©ºç¼“å­˜,é˜²æ­¢å¤§é‡éæ³•è¯·æ±‚é€ æˆç¼“å­˜ç©¿é€
		err = l.svcCtx.Rdb.Set(l.ctx,
			fmt.Sprintf("user_login_%s", in.Username),
			fmt.Sprintf("%d:%d", 0, 0),
			time.Second*86400).Err()
		if err != nil {
			logger.Errorf("update [user_login] cache failed, err: %v", err)
		}
		res = &pb.LoginRes{
			Code: http.StatusNotFound,
			Msg:  "uid not exist",
			Ok:   false,
		}
		logger.Debugf("send message: %v", res.String())
		return res, nil
	default:
		{
			logger.Errorf("query [user_subject] in mysql failed, err: %v", err)
			res = &pb.LoginRes{
				Code: http.StatusInternalServerError,
				Msg:  "internal err",
				Ok:   false,
			}
			logger.Debugf("send message: %v", res.String())
			return res, err
		}
	}
	
	...
	
		err = l.svcCtx.Rdb.Set(l.ctx,
		fmt.Sprintf("user_login_%s", in.Username),
		fmt.Sprintf("%d:%s", userSubject.ID, userSubject.Password),
		time.Second*86400).Err()
	if err != nil {
		logger.Errorf("set [user_login] cache failed, err: %v", err)
	}
```

- IP å½’å±åœ°

> å¯¹ç”¨æˆ·ç™»å½•çš„IPè¿›è¡Œè§£æï¼ˆå…·ä½“çœ‹æˆ‘ [ip-parse](https://github.com/StellarisW/ip-parse) ä»“åº“ï¼‰ï¼Œåœ¨å›ç­”å†…å®¹ï¼Œè¯„è®ºå†…å®¹ä¸­è®¾ç½®ç”¨æˆ·IPå½’å±åœ°

<!--app/utils/net/ip/ip.go-->

```go
func GetIpLocFromApi(ip string) (loc string) {
   var err error
   if domain == "" {
      domain, err = apollo.GetMainDomain()
      if err != nil {
         return "æœªçŸ¥"
      }
   }
   apiAddr := "http://ip." + domain + "/api/parse?ip=" + ip
   res, err := req.NewRequest().Get(apiAddr)
   j := gjson.Parse(res.String())
   if j.Get("ok").Bool() == false {
      return "æœªçŸ¥"
   }
   locStr := j.Get("location").String()
   output := strings.Split(locStr, "|")
   if output[0] != "ä¸­å›½" {
      return output[0]
   }
   strings.Trim(output[2], "çœ")
   return output[2]
}
```

- ç”¨æˆ·ä¿¡æ¯ç¼“å­˜

> å¯¹`user-subject`,`user-collect`è¡¨è¿›è¡Œç¼“å­˜ï¼Œé’ˆå¯¹é«˜é¢‘æ›´æ–°çš„å­—æ®µ(å¦‚ `user-subject` ä¸­çš„ `follower` ï¼Œ `user-collect` ä¸­çš„èµåŒæ“ä½œ)è¿›è¡Œå®šæ—¶æ›´æ–°æ•°æ®åº“çš„æ“ä½œ

<!--app/service/mq/asynq/processor/internal/logic/user/task.go-->

```go
func (l *ScheduleUpdateUserSubjectRecordHandler) ProcessTask(ctx context.Context, _ *asynq.Task) (err error) {
    // è·å–ç¼“å­˜ä¸­éœ€è¦æ›´æ–°ç”¨æˆ· follower å­—æ®µçš„ç”¨æˆ·id
   members, err := l.Rdb.SMembers(ctx,
      "user_follower_cnt_set").Result()
   if err != nil {
      return fmt.Errorf("get [user_follower] member failed, err: %v", err)
   }
   l.Rdb.Del(ctx,
      fmt.Sprintf("user_follower_cnt_set"))

   userSubjectModel := l.UserModel.UserSubject
   for _, member := range members {
       // è·å–ç¼“å­˜ä¸­ follower çš„æ•°é‡
      followerCount, err := l.Rdb.Get(ctx,
         fmt.Sprintf("user_follower_cnt_%s", member)).Int()
      if err != nil {
         return fmt.Errorf("get [user_follower] cnt failed, err: %v", err)
      }

      err = l.Rdb.Del(ctx,
         fmt.Sprintf("user_follower_cnt_%s", member)).Err()
      if err != nil {
         return fmt.Errorf("del [user_follower] cnt failed, err: %v", err)
      }
	
       // æ›´æ–°æ•°æ®åº“
      userSubject, err := userSubjectModel.WithContext(ctx).
         Select(userSubjectModel.ID, userSubjectModel.Follower).
         Where(userSubjectModel.ID.Eq(cast.ToInt64(member))).
         First()
      if err != nil {
         return fmt.Errorf("get [user_subject] record failed, err: %v", err)
      }

      _, err = userSubjectModel.WithContext(ctx).
         Select(userSubjectModel.ID, userSubjectModel.Follower).
         Where(userSubjectModel.ID.Eq(cast.ToInt64(member))).
         Update(userSubjectModel.Follower, int(userSubject.Follower)+followerCount)
      if err != nil {
         return fmt.Errorf("update [user_subject] record failed, err: %v", err)
      }
   }

   return nil
}
```

#### é—®ç­”ç³»ç»Ÿ

- é—®é¢˜ä¸å›ç­”ä¿¡æ¯ç¼“å­˜

> ä¹Ÿæ˜¯å’Œä¸Šé¢ä¸€æ ·çš„é€»è¾‘ï¼Œå¯¹è¡¨è¿›è¡Œç¼“å­˜ï¼Œé«˜é¢‘å­—æ®µå®šæ—¶æ•°æ®åº“åŒæ­¥

- å›ç­”ç‚¹èµ

<!--app/service/user/rpc/crud/internal/logic/docollectionlogin.go-->

```go
// é€šçŸ¥ç”¨æˆ·
err = notificationMqProducer.PublishNotification(producer, notificationMqProducer.PublishNotificationMessage{
   MessageType: 2,
   Data: notificationMqProducer.ApproveAndLikeData{
      UserId:  in.UserId,
      Action:  1,
      ObjType: in.ObjType,
      ObjId:   in.ObjId,
   },
})
if err != nil {
   return fmt.Errorf("publish notificaion to nsq failed, %v", err)
}

// æ›´æ–°ç¼“å­˜
err = svcCtx.Rdb.Incr(ctx,
   fmt.Sprintf("answer_index_approve_cnt_%d", in.ObjId)).Err()
if err != nil {
   return fmt.Errorf("incr [answer_index_approve_cnt] failed, %v", err)
}

err = svcCtx.Rdb.SAdd(ctx,
   "answer_index_approve_cnt_set",
   in.ObjId).Err()
if err != nil {
   return fmt.Errorf("update [answer_index_approve_cnt_set] failed, err: %v", err)
}
```

#### è¯„è®ºç³»ç»Ÿ

- ä½è€¦åˆ

> å°†è¯„è®ºè¿™ä¸ªæ¨¡å—å•ç‹¬ä»å›ç­”ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œæ–¹ä¾¿åç»­çš„åŠŸèƒ½éœ€è¦è¯„è®ºæ¨¡å—çš„ä½¿ç”¨

- ä¿¡æ¯å…¨é¢

> æ˜¾ç¤ºå›å¤çš„ç”¨æˆ·idå’Œè¢«å›å¤çš„ç”¨æˆ·idï¼Œå›å¤çš„ipå½’å±åœ°ç­‰ç­‰

#### é€šçŸ¥ç³»ç»Ÿ

- å‘å¸ƒè®¢é˜…

> ä½¿ç”¨nsqå¯¹ç”¨æˆ·çš„å„ç§æ“ä½œ(å¦‚å…³æ³¨ï¼Œç‚¹èµç­‰ç­‰)å¯¹æ“ä½œçš„å¯¹è±¡(è¢«å…³æ³¨çš„äººï¼Œè¢«ç‚¹èµå›ç­”çš„ä½œè€…)è¿›è¡Œé€šçŸ¥

<!--app/service/mq/nsq/consumer/internal/listen/notification/handler.go-->

```go
func (m *PublishNotificationHandler) HandleMessage(nsqMsg *nsq.Message) (err error) {
   msg := &notificationMqProducer.PublishNotificationMessage{}
   err = json.Unmarshal(nsqMsg.Body, &msg)
   if err != nil {
      return fmt.Errorf("unmarshal msg failed, %v", err)
   }

   ctx := context.Background()
   switch msg.MessageType {
   case 1:
      // å…³æ³¨æˆ‘çš„
      data := &notificationMqProducer.FollowerData{}

      bytesData, err := json.Marshal(msg.Data)
      if err != nil {
         return fmt.Errorf("marshal msg data failed, %v", err)
      }

      err = json.Unmarshal(bytesData, &data)
      if err != nil {
         return fmt.Errorf("unmarshal msg data failed, %v", err)
      }

      userInfoRes, err := req.NewRequest().Get(
         fmt.Sprintf("https://%s/api/user/profile/%s", m.Domain, cast.ToString(data.FollowerId)))
      if err != nil {
         return fmt.Errorf("query user info failed, %v", err)
      }

      j := gjson.Parse(userInfoRes.String())
      if !j.Get("ok").Bool() {
         return fmt.Errorf("query user info failed, %v", j.Get("msg").String())
      }

      rpcRes, _ := m.NotificationCrudRpcClient.PublishNotification(ctx, &crud.PublishNotificationReq{
         UserId:      data.UserId,
         MessageType: 1,
         Title:       fmt.Sprintf("ç”¨æˆ· %s å…³æ³¨äº†ä½ ", j.Get("data.nickname").String()),
         Content:     "",                                                              // ç©º
         Url:         fmt.Sprintf("https://%s/profile/%d", m.Domain, data.FollowerId), // ç”¨æˆ·ä¸»é¡µ
      })
      if !rpcRes.Ok {
         return fmt.Errorf("publish notification failed, %v", rpcRes.Msg)
      }
      
      ...
      
}
```

### è¿ç»´

#### æœåŠ¡å‘ç°

> é€šè¿‡go-zeroæ¡†æ¶çš„åŸç”Ÿæ”¯æŒï¼Œæ¥è¿›è¡ŒæœåŠ¡çš„å‘ç°ä¸è°ƒç”¨æ“ä½œ

![image-20220902154029133](./manifest/image/consul.png)

#### é“¾è·¯è¿½è¸ª

> é€šè¿‡go-zeroæ¡†æ¶çš„åŸç”Ÿæ”¯æŒï¼Œè¿›è¡Œå¯¹æœåŠ¡çš„é“¾è·¯è¿½è¸ªï¼Œæ–¹ä¾¿debug

 ![image-20220902154140585](./manifest/image/jaeger.png)

#### é…ç½®ç®¡ç†

> åœ¨apolloå¹³å°ä¸Šè¿›è¡Œé…ç½®çš„æ›´æ”¹æ“ä½œï¼Œç„¶ågoåç«¯è¯»å–apolloçš„é…ç½®æ–‡ä»¶åï¼Œç¼“å­˜åœ¨æœ¬åœ°ï¼ŒåŒæ—¶è¿›è¡Œé…ç½®çš„çƒ­æ›´æ–°ï¼Œ
>
> ç„¶åä½¿ç”¨viperæ¥è¿›è¡Œé…ç½®æ–‡ä»¶çš„è¯»å–æ“ä½œ

![image-20220902153815361](./manifest/image/apollo.png)

#### ç½‘å…³ä»£ç†

> ä½¿ç”¨traefikå¯¹å¾®æœåŠ¡è¿›è¡Œåå‘ä»£ç†ï¼ŒåŒæ—¶è‡ªåŠ¨ç”ŸæˆCAè¯ä¹¦ï¼Œå¯¹å…¨éƒ¨çš„å¾®æœåŠ¡è¿›è¡Œtlsè®¤è¯

![image-20220902154403897](./manifest/image/traefik.png)

#### é¡¹ç›®éƒ¨ç½²

> ä»£ç pushåˆ°gogsä»“åº“

![image-20220902154503351](./manifest/image/gogs.png)

> droneé€šè¿‡webé’©å­æ‹·è´ä»£ç 

![image-20220902154545273](./manifest/image/webhook.png)

> droneè¿›è¡ŒæŒç»­é›†æˆæ“ä½œ

![image-20220902154620156](./manifest/image/drone.png)

> docker-compose å¹¶å‘æ„å»ºé•œåƒ

`build.sh`

``` sh
#!/bin/bash

export PROJECT_NAME=$1

export THREAD=$2

docker_names=('oauth-api' 'oauth-rpc-token-enhancer' 'oauth-rpc-token-store' \
'user-api' 'user-rpc-crud' 'user-rpc-info' 'user-rpc-vip' 'notification-api' \
'notification-rpc-crud' 'notification-rpc-info' 'mq-asynq-scheduler' 'mq-asynq-processor' \
'mq-nsq-consumer')

function docker_build() {
  if [ "$1" -ef "" ]; then
    return 0
  fi

  array=$(echo "$1" | tr '-' '\n')
  path='./app/service'
  for var in $array
  do
    path="${path}""/""${var}"
  done
  docker build -t "$PROJECT_NAME""_""$1" "${path}"
  return 1
}

[ -e /tmp/fd1 ] || mkfifo /tmp/fd1
exec 3<>/tmp/fd1
rm -rf /tmp/fd1

for ((i=1;i<=THREAD;i++))
do
  echo >&3
done

cd /www/site/"$PROJECT_NAME" || exit

remain_build=${#docker_names[@]}

echo "start building images, remain: ""${remain_build}"

for docker_name in ${docker_names[*]}
do
  read -r -u3
{
  docker_build "${docker_name}"
  remain_build=$(expr "${remain_build}" - 1)
  echo "build ""${docker_name}"" complete, remain: ""${remain_build}"
  echo >&3
} &
done

wait

exec 3<&-
exec 3>&-
```

## ğŸ—¼æ¶æ„è®¾è®¡

![clouddiskæ¶æ„å›¾](./manifest/image/architecture.jpg)

## ğŸ“‚ å­˜å‚¨è®¾è®¡

### è¡¨è®¾è®¡

#### ç”¨æˆ·ç³»ç»Ÿ

##### `user_subject`

##### è®°å½•

![](./manifest/image/user_subject_record.png)

ç´¢å¼•

![](./manifest/image/user_subject_record_index.png)

##### `user_collection`

è®°å½•

![](./manifest/image/user_collection_record.png)

ç´¢å¼•

![](./manifest/image/user_collection_index.png)

å¤–é”®

![](./manifest/image/user_collection_foreign_key.png)

#### é—®ç­”ç³»ç»Ÿ

##### `question_subject`

è®°å½•

![](./manifest/image/question_subject_record.png)

ç´¢å¼•

![](./manifest/image/question_subject_index.png)



##### `question_content`

è®°å½•

![](./manifest/image/question_content_record.png)

å¤–é”®

![](./manifest/image/question_content_foreign_key.png)



##### `answer_index`

è®°å½•

![](./manifest/image/answer_index_record.png)

ç´¢å¼•

![](./manifest/image/answer_index_index.png)

å¤–é”®

![](./manifest/image/answer_index_foreign_key.png)



##### `answer_content`

è®°å½•

![](./manifest/image/answer_content_record.png)

å¤–é”®![](./manifest/image/answer_content_foreign_key.png)

#### è¯„è®ºç³»ç»Ÿ

##### `comment_subject`

è®°å½•

![](./manifest/image/comment_subject_record.png)

ç´¢å¼•

![](./manifest/image/comment_subject_index.png)



##### `comment_index`

è®°å½•

![](./manifest/image/comment_index_record.png)

ç´¢å¼•

![](./manifest/image/comment_index_index.png)

å¤–é”®

![](./manifest/image/comment_index_foreign_key.png)



##### `comment_content`

è®°å½•

![](./manifest/image/comment_content_record.png)

å¤–é”®

![](./manifest/image/comment_content_foreign_key.png)

#### é€šçŸ¥ç³»ç»Ÿ

##### `notification_subject`

è®°å½•

![](./manifest/image/notification_subject_record.png)

ç´¢å¼•

![](./manifest/image/notification_subuject_index.png)

å¤–é”®

![](./manifest/image/notification_subject_foreign_key.png)





##### `notification_content`

è®°å½•

![](./manifest/image/notification_content_record.png)



å¤–é”®

![](./manifest/image/notification_content_foreign_key.png)



### ç¼“å­˜è®¾è®¡

#### jwt ç¼“å­˜

ç¼“å­˜ Oauth2 Tokenï¼Œåˆ©ç”¨ redis ç‰¹æ€§è‡ªåŠ¨å®ç°ä»¤ç‰Œè¿‡æœŸåŠŸèƒ½

![](./manifest/image/jwt_cache.png)

#### è¡¨ç¼“å­˜

> è¡¨è®°å½•çš„æ•°æ®æ¯”è¾ƒå¤šï¼Œå› æ­¤é‡‡ç”¨protobugè¿›è¡Œåºåˆ—åŒ–ï¼Œè€Œä¸æ˜¯ç”¨jsonï¼Œ
>
> å› ä¸ºåœ¨protobufçš„ç¼–è§£ç æ€§èƒ½è¿œè¿œé«˜å‡ºJSONçš„æ€§èƒ½ã€‚
>
> åŒæ—¶å ç”¨ç©ºé—´ä¹Ÿæ¯”jsonå°å¾ˆå¤šï¼Œå¤§å¤§å‡å°‘äº†ç¼“å­˜è¡¨çš„å¼€é”€

ä¸‹é¢æ˜¯ `user_subject` è¡¨çš„ç¼“å­˜æ ·ä¾‹

<!--app/service/mq/asynq/processor/internal/logic/user/task.go-->

```go
func (l *MsgCreateUserSubjectHandler) ProcessTask(ctx context.Context, task *asynq.Task) (err error) {
   var payload job.MsgCreateUserSubjectPayload
   if err = json.Unmarshal(task.Payload(), &payload); err != nil {
      return fmt.Errorf("unmarshal [MsgCreateUserSubjectPayload] failed, err: %v", err)
   }

   userSubjectId := l.IdGenerator.NewLong()

   userSubjectModel := l.UserModel.UserSubject

   now := time.Now()

   err = userSubjectModel.WithContext(ctx).
      Create(&model.UserSubject{
         ID:         userSubjectId,
         Username:   payload.Username,
         Password:   payload.Password,
         Nickname:   payload.Nickname,
         CreateTime: now,
         UpdateTime: now,
      })
   if err != nil {
      return fmt.Errorf("create [user_subject] record failed, err: %v", err)
   }

   userSubjectProto := &pb.UserSubject{
      Id:         userSubjectId,
      Username:   payload.Username,
      Password:   payload.Password,
      Nickname:   payload.Nickname,
      CreateTime: now.String(),
      UpdateTime: now.String(),
   }

   userSubjectBytes, err := proto.Marshal(userSubjectProto)
   if err != nil {
      return fmt.Errorf("marshal [userSubjectProto] into proto failed, err: %v", err)
   }

   err = l.Rdb.Set(ctx,
      fmt.Sprintf("user_subject_%d", userSubjectId),
      userSubjectBytes,
      time.Second*86400).Err()
   if err != nil {
      return fmt.Errorf("update [user_subject] cache failed, err: %v", err)
   }

   err = l.Rdb.Set(ctx,
      fmt.Sprintf("user_login_%d", userSubjectId),
      fmt.Sprintf("%d:%s", userSubjectId, payload.Password),
      time.Second*86400).Err()
   if err != nil {
      return fmt.Errorf("update [user_login] cache failed, err: %v", err)
   }

   return nil
}
```

key æ ¼å¼ï¼š `[tableName]_[primaryId]`

ä¾‹å¦‚ `user_subject` çš„ç¼“å­˜

![](./manifest/image/user_subject_cache.png)

#### æ³¨å†Œç¼“å­˜

ä½¿ç”¨é›†åˆå­˜å‚¨å·²ç»æ³¨å†Œçš„ç”¨æˆ·åï¼ˆåç»­é›†åˆè¿‡å¤§æ—¶ï¼Œè€ƒè™‘éšæœºåˆ é™¤é›†åˆä¸­çš„ç”¨æˆ·åå‡å°ç¼“å­˜å‹åŠ›ï¼‰

key åç§°ï¼š`user_register_set`

![](./manifest/image/user_register_set.png)

#### ç™»å½•ç¼“å­˜

ä½¿ç”¨ key å­˜å‚¨ç”¨æˆ· id ä¸åŠ ç›åçš„å¯†ç 

key æ ¼å¼ï¼š`user_login_[username]`

![](./manifest/image/user_login_cache.png)

#### æ”¶è—ç¼“å­˜

key æ ¼å¼ï¼š`user_collect_set_[userId]_[collectType]_[objType]`

![](./manifest/image/user_collect_set.png)

#### å…³æ³¨ç”¨æˆ·ç¼“å­˜

key æ ¼å¼ï¼š`user_follwer_cnt_set` `user_follower_cnt_[userId]`

ç¼“å­˜å…³æ³¨ç”¨æˆ·çš„æ•°é‡ï¼Œç„¶åæ ¹æ®è¿™ä¸ªæ•°é‡æ•°æ®åº“å®šæ—¶ç»Ÿä¸€æ›´æ–°ï¼Œå¤§å¤§å‡å°æ•°æ®åº“å‹åŠ›

key æ ¼å¼ï¼š`user_follower_member_set_[userId]`

ç¼“å­˜ç”¨æˆ·ä¸‹çš„å…³æ³¨è€…é›†åˆï¼Œæ–¹ä¾¿å‘å¸ƒé€šçŸ¥

![](./manifest/image/user_follower_member_set.png)

#### é€šçŸ¥ç¼“å­˜

key æ ¼å¼ï¼š`notification_[userId]_[notificationType]`

ç¼“å­˜ç”¨æˆ·é€šçŸ¥ä¸‹çš„ä¸€ä¸ª id é›†åˆ

#### å‘å¸ƒç¼“å­˜

key æ ¼å¼ï¼š`question_id_user_set_[userId]` `answer_id_user_set_[userId]` `comment_id_user_set_[userId]`

ç¼“å­˜ç”¨æˆ·å‘å¸ƒå¯¹è±¡çš„çš„ id é›†åˆ

## ğŸ“– APIæ–‡æ¡£

[æ¥å£æ–‡æ¡£](https://documenter.getpostman.com/view/22490304/VUxStm2d)

## âš™ é¡¹ç›®ç»“æ„

<details>
<summary>å±•å¼€æŸ¥çœ‹</summary>
<pre>
<code>
    â”œâ”€â”€ app ----------------------------- (é¡¹ç›®æ–‡ä»¶)
        â”œâ”€â”€ common ---------------------- (å…¨å±€é€šç”¨ç›®å½•)
        	â”œâ”€â”€ config ------------------ (è·å–é…ç½®æ–‡ä»¶ç›¸å…³)
        	â”œâ”€â”€ log --------------------- (æ—¥å¿—é…ç½®)
        	â”œâ”€â”€ middleware -------------- (ä¸­é—´ä»¶)
        	â”œâ”€â”€ model ------------------- (å…¨å±€æ¨¡å‹)
        	â”œâ”€â”€ mq ---------------------- (æ¶ˆæ¯é˜Ÿåˆ—è®¾ç½®)
        â”œâ”€â”€ service --------------------- (å¾®æœåŠ¡)
            â”œâ”€â”€ comment ----------------- (è¯„è®ºç³»ç»Ÿ)
            â”œâ”€â”€ mq ---------------------- (æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡)
            â”œâ”€â”€ notification ------------ (é€šçŸ¥ç³»ç»Ÿ)
            â”œâ”€â”€ oauth ------------------- (è®¤è¯ç³»ç»Ÿ)
            â”œâ”€â”€ question ---------------- (é—®ç­”ç³»ç»Ÿ)
            â”œâ”€â”€ user -------------------- (ç”¨æˆ·ç³»ç»Ÿ)
    â”œâ”€â”€ manifest ------------------------ (äº¤ä»˜æ¸…å•)
    	â”œâ”€â”€ deploy ---------------------- (éƒ¨ç½²é…ç½®æ–‡ä»¶)
    		â”œâ”€â”€ docker ------------------ (dockeré…ç½®æ–‡ä»¶)
    		â”œâ”€â”€ kustomize --------------- (k8sé…ç½®æ–‡ä»¶)
        â”œâ”€â”€ sql ------------------------- (mysqlåˆå§‹åŒ–é…ç½®æ–‡ä»¶)
    â”œâ”€â”€ utils --------------------------- (å·¥å…·åŒ…)              
    â”œâ”€â”€ .drone.yml ---------------------- (droneè‡ªåŠ¨æ„å»ºé…ç½®æ–‡ä»¶)
    â”œâ”€â”€ docker-compose.yaml ------------- (docker-composeé…ç½®æ–‡ä»¶)
</code>
</pre>
</details>


## ğŸ›  ç¯å¢ƒè¦æ±‚

- golang ç‰ˆæœ¬ ~= 1.19
- mysql ç‰ˆæœ¬ ~=5.7
- redis ç‰ˆæœ¬ ~=5.0

## ğŸ“Œ TODO

- [x] OAuthæˆæƒæœåŠ¡å™¨
- [x] ç”¨æˆ·ç™»å½•/æ³¨å†Œ
- [x] å‘å¸ƒé—®é¢˜
- [x] å›ç­”é—®é¢˜
- [x] è¯„è®ºå›ç­”
- [x] è·å–è‡ªå·±çš„æ‰€æœ‰é—®é¢˜ã€å›ç­”ã€è¯„è®º
- [x] åˆ é™¤æˆ–ä¿®æ”¹è‡ªå·±å‘å¸ƒçš„é—®é¢˜ã€å›ç­”ã€è¯„è®º
- [x] èµåŒ
- [x] å…³æ³¨
- [x] æ”¶è—
- [x] é€šçŸ¥
- [ ] çƒ­æ¦œ
- [ ] ç›é€‰ä¼šå‘˜
- [ ] æ–‡ç« 
